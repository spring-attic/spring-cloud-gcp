<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>15.&nbsp;Cloud Identity-Aware Proxy (IAP) Authentication</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="multi_spring-cloud-gcp.html" title="Spring Cloud GCP"><link rel="up" href="multi_spring-cloud-gcp.html" title="Spring Cloud GCP"><link rel="prev" href="multi__cloud_memorystore_for_redis.html" title="14.&nbsp;Cloud Memorystore for Redis"><link rel="next" href="multi__google_cloud_vision.html" title="16.&nbsp;Google Cloud Vision"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">15.&nbsp;Cloud Identity-Aware Proxy (IAP) Authentication</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi__cloud_memorystore_for_redis.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__google_cloud_vision.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_cloud_identity_aware_proxy_iap_authentication" href="#_cloud_identity_aware_proxy_iap_authentication"></a>15.&nbsp;Cloud Identity-Aware Proxy (IAP) Authentication</h1></div></div></div><p><a class="link" href="https://cloud.google.com/iap/" target="_top">Cloud Identity-Aware Proxy (IAP)</a> provides a security layer over applications deployed to Google Cloud.</p><p>The IAP starter uses <a class="link" href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#oauth2resourceserver" target="_top">Spring Security OAuth 2.0 Resource Server</a> functionality to automatically extract user identity from the proxy-injected <code class="literal">x-goog-iap-jwt-assertion</code> HTTP header.</p><p>The following claims are validated automatically:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Issue time</li><li class="listitem">Expiration time</li><li class="listitem">Issuer</li><li class="listitem">Audience</li></ul></div><p>The <span class="emphasis"><em>audience</em></span> (<code class="literal">"aud"</code> claim) validation string is automatically determined when the application is running on App Engine Standard or App Engine Flexible.
This functionality relies on Cloud Resource Manager API to retrieve project details, so the following setup is needed:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Enable Cloud Resource Manager API in <a class="link" href="https://console.developers.google.com/apis/api/cloudresourcemanager.googleapis.com" target="_top">GCP Console</a>.</li><li class="listitem">Make sure your application has <code class="literal">resourcemanager.projects.get</code> permission.</li></ul></div><p>App Engine automatic <span class="emphasis"><em>audience</em></span> determination can be overridden by using <code class="literal">spring.cloud.gcp.security.iap.audience</code> property.</p><p>For Compute Engine or Kubernetes Engine <code class="literal">spring.cloud.gcp.security.iap.audience</code> property <span class="strong"><strong>must</strong></span> be provided, as the <span class="emphasis"><em>audience</em></span> string depends on the specific Backend Services setup and cannot be inferred automatically.
To determine the <span class="emphasis"><em>audience</em></span> value, follow directions in IAP <a class="link" href="https://cloud.google.com/iap/docs/signed-headers-howto#verify_the_jwt_payload" target="_top">Verify the JWT payload</a> guide.
If <code class="literal">spring.cloud.gcp.security.iap.audience</code> is not provided, the application will fail to start the following message:</p><pre class="screen">No qualifying bean of type 'org.springframework.cloud.gcp.security.iap.AudienceProvider' available.</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you create a custom <a class="link" href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" target="_top"><code class="literal">WebSecurityConfigurerAdapter</code></a>, enable extracting user identity by adding <code class="literal">.oauth2ResourceServer().jwt()</code> configuration to the <a class="link" href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/builders/HttpSecurity.html" target="_top"><code class="literal">HttpSecurity</code></a> object.
 If no custom <a class="link" href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" target="_top"><code class="literal">WebSecurityConfigurerAdapter</code></a> is present, nothing needs to be done because Spring Boot will add this customization by default.</p></td></tr></table></div><p>Starter Maven coordinates, using <a class="link" href="multi__getting_started.html#_bill_of_materials" title="2.1.1&nbsp;Bill of Materials">Spring Cloud GCP BOM</a>:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-starter-security-iap<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Starter Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-security-iap'
}</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuration_6" href="#_configuration_6"></a>15.1&nbsp;Configuration</h2></div></div></div><p>The following properties are available.</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>Modifying registry, algorithm, and header properties might be useful for testing, but the defaults should not be changed in production.</p></td></tr></table></div><div class="informaltable"><table class="informaltable" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top">Name</th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top">Description</th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top">Required</th><th style="border-bottom: 1px solid ; " align="left" valign="top">Default</th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.security.iap.registry</code></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>Link to JWK public key registry.</p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://www.gstatic.com/iap/verify/public_key-jwk" target="_top">https://www.gstatic.com/iap/verify/public_key-jwk</a></code></p></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.security.iap.algorithm</code></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>Encryption algorithm used to sign the JWK token.</p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">ES256</code></p></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.security.iap.header</code></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>Header from which to extract the JWK key.</p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">x-goog-iap-jwt-assertion</code></p></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.security.iap.issuer</code></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>JWK issuer to verify.</p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 1px solid ; " align="left" valign="top"><p><code class="literal"><a class="link" href="https://cloud.google.com/iap" target="_top">https://cloud.google.com/iap</a></code></p></td></tr><tr><td style="border-right: 1px solid ; " align="left" valign="top"><p><code class="literal">spring.cloud.gcp.security.iap.audience</code></p></td><td style="border-right: 1px solid ; " align="left" valign="top"><p>Custom JWK audience to verify.</p></td><td style="border-right: 1px solid ; " align="left" valign="top"><p>false on App Engine; true on GCE/GKE</p></td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_11" href="#_sample_11"></a>15.2&nbsp;Sample</h2></div></div></div><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-security-iap-sample" target="_top">sample application</a> is available.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi__cloud_memorystore_for_redis.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__google_cloud_vision.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">14.&nbsp;Cloud Memorystore for Redis&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-gcp.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;16.&nbsp;Google Cloud Vision</td></tr></table></div></body></html>