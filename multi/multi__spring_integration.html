<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>7.&nbsp;Spring Integration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="multi_spring-cloud-gcp.html" title="Spring Cloud GCP"><link rel="up" href="multi_spring-cloud-gcp.html" title="Spring Cloud GCP"><link rel="prev" href="multi__spring_jdbc.html" title="6.&nbsp;Spring JDBC"><link rel="next" href="multi__spring_cloud_stream.html" title="8.&nbsp;Spring Cloud Stream"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.&nbsp;Spring Integration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi__spring_jdbc.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__spring_cloud_stream.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_spring_integration" href="#_spring_integration"></a>7.&nbsp;Spring Integration</h1></div></div></div><p>Spring Cloud GCP provides Spring Integration adapters that allow your applications to use Enterprise Integration Patterns backed up by Google Cloud Platform services.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channel_adapters_for_cloud_pubsub" href="#_channel_adapters_for_cloud_pubsub"></a>7.1&nbsp;Channel Adapters for Cloud Pub/Sub</h2></div></div></div><p>The channel adapters for Google Cloud Pub/Sub connect your Spring <a class="link" href="https://docs.spring.io/spring-integration/reference/html/messaging-channels-section.html#channel" target="_top"><code class="literal">MessageChannels</code></a> to Google Cloud Pub/Sub topics and subscriptions.
This enables messaging between different processes, applications or micro-services backed up by Google Cloud Pub/Sub.</p><p>The Spring Integration Channel Adapters for Google Cloud Pub/Sub are included in the <code class="literal">spring-cloud-gcp-pubsub</code> module.</p><p>Maven coordinates, using <a class="link" href="multi__getting_started.html#_bill_of_materials" title="2.1.1&nbsp;Bill of Materials">Spring Cloud GCP BOM</a>:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-pubsub<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-core<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-pubsub'
    compile group: 'org.springframework.integration', name: 'spring-integration-core'
}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_channel_adapter_using_pubsub_streaming_pull" href="#_inbound_channel_adapter_using_pubsub_streaming_pull"></a>7.1.1&nbsp;Inbound channel adapter (using Pub/Sub Streaming Pull)</h3></div></div></div><p><code class="literal">PubSubInboundChannelAdapter</code> is the inbound channel adapter for GCP Pub/Sub that listens to a GCP Pub/Sub subscription for new messages.
It converts new messages to an internal Spring <a class="link" href="https://docs.spring.io/spring-integration/reference/html/messaging-construction-chapter.html#message" target="_top"><code class="literal">Message</code></a> and then sends it to the bound output channel.</p><p>Google Pub/Sub treats message payloads as byte arrays.
So, by default, the inbound channel adapter will construct the Spring <code class="literal">Message</code> with <code class="literal">byte[]</code> as the payload.
However, you can change the desired payload type by setting the <code class="literal">payloadType</code> property of the <code class="literal">PubSubInboundChannelAdapter</code>.
The <code class="literal">PubSubInboundChannelAdapter</code> delegates the conversion to the desired payload type to the <code class="literal">PubSubMessageConverter</code> configured in the <code class="literal">PubSubTemplate</code>.</p><p>To use the inbound channel adapter, a <code class="literal">PubSubInboundChannelAdapter</code> must be provided and configured on the user application side.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageChannel pubsubInputChannel() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PublishSubscribeChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> PubSubInboundChannelAdapter messageChannelAdapter(
    <em><span class="hl-annotation" style="color: gray">@Qualifier("pubsubInputChannel")</span></em> MessageChannel inputChannel,
    SubscriberFactory subscriberFactory) {
    PubSubInboundChannelAdapter adapter =
        <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubInboundChannelAdapter(subscriberFactory, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"subscriptionName"</span>);
    adapter.setOutputChannel(inputChannel);
    adapter.setAckMode(AckMode.MANUAL);

    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> adapter;
}</pre><p>In the example, we first specify the <code class="literal">MessageChannel</code> where the adapter is going to write incoming messages to.
The <code class="literal">MessageChannel</code> implementation isn&#8217;t important here.
Depending on your use case, you might want to use a <code class="literal">MessageChannel</code> other than <code class="literal">PublishSubscribeChannel</code>.</p><p>Then, we declare a <code class="literal">PubSubInboundChannelAdapter</code> bean.
It requires the channel we just created and a <code class="literal">SubscriberFactory</code>, which creates <code class="literal">Subscriber</code> objects from the Google Cloud Java Client for Pub/Sub.
The Spring Boot starter for GCP Pub/Sub provides a configured <code class="literal">SubscriberFactory</code>.</p><p>The <code class="literal">PubSubInboundChannelAdapter</code> supports three acknowledgement modes, with <code class="literal">AckMode.AUTO</code> being the default value;</p><p>Automatic acking (<code class="literal">AckMode.AUTO</code>)</p><p>A message is acked with GCP Pub/Sub if the adapter sent it to the channel and no exceptions were thrown.
If a <code class="literal">RuntimeException</code> is thrown while the message is processed, then the message is nacked.</p><p>Automatic acking OK (<code class="literal">AckMode.AUTO_ACK</code>)</p><p>A message is acked with GCP Pub/Sub if the adapter sent it to the channel and no exceptions were thrown.
If a <code class="literal">RuntimeException</code> is thrown while the message is processed, then the message is neither acked / nor nacked.</p><p>This is useful when using the subscription&#8217;s ack deadline timeout as a retry delivery backoff mechanism.</p><p>Manually acking (<code class="literal">AckMode.MANUAL</code>)</p><p>The adapter attaches a <code class="literal">BasicAcknowledgeablePubsubMessage</code> object to the <code class="literal">Message</code> headers.
Users can extract the <code class="literal">BasicAcknowledgeablePubsubMessage</code> using the <code class="literal">GcpPubSubHeaders.ORIGINAL_MESSAGE</code> key and use it to (n)ack a message.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "pubsubInputChannel")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler messageReceiver() {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> message -&gt; {
        LOGGER.info(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Message arrived! Payload: "</span> + <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> String((<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">byte</span>[]) message.getPayload()));
        BasicAcknowledgeablePubsubMessage originalMessage =
              message.getHeaders().get(GcpPubSubHeaders.ORIGINAL_MESSAGE, BasicAcknowledgeablePubsubMessage.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
        originalMessage.ack();
    };
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pollable_message_source_using_pubsub_synchronous_pull" href="#_pollable_message_source_using_pubsub_synchronous_pull"></a>7.1.2&nbsp;Pollable Message Source (using Pub/Sub Synchronous Pull)</h3></div></div></div><p>While <code class="literal">PubSubInboundChannelAdapter</code>, through the underlying Asynchronous Pull Pub/Sub mechanism, provides the best performance for high-volume applications that receive a steady flow of messages, it can create load balancing anomalies due to message caching.
This behavior is most obvious when publishing a large batch of small messages that take a long time to process individually.
It manifests as one subscriber taking up most messages, even if multiple subscribers are available to take on the work.
For a more detailed explanation of this scenario, see <a class="link" href="https://cloud.google.com/pubsub/docs/pull#dealing-with-large-backlogs-of-small-messages" target="_top">GCP Pub/Sub documentation</a>.</p><p>In such a scenario, a <code class="literal">PubSubMessageSource</code> can help spread the load between different subscribers more evenly.</p><p>As with the Inbound Channel Adapter, the message source has a configurable acknowledgement mode, payload type, and header mapping.</p><p>The default behavior is to return from the synchronous pull operation immediately if no messages are present.
This can be overridden by using <code class="literal">setBlockOnPull()</code> method to wait for at least one message to arrive.</p><p>By default, <code class="literal">PubSubMessageSource</code> pulls from the subscription one message at a time.
To pull a batch of messages on each request, use the <code class="literal">setMaxFetchSize()</code> method to set the batch size.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "pubsubInputChannel", poller = @Poller(fixedDelay = "100"))</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageSource&lt;Object&gt; pubsubAdapter(PubSubTemplate pubSubTemplate) {
	PubSubMessageSource messageSource = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubMessageSource(pubSubTemplate,  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"exampleSubscription"</span>);
	messageSource.setAckMode(AckMode.MANUAL);
	messageSource.setPayloadType(String.<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">class</span>);
	messageSource.setBlockOnPull(true);
	messageSource.setMaxFetchSize(<span class="hl-number">100</span>);
	<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> messageSource;
}</pre><p>The <code class="literal">@InboundChannelAdapter</code> annotation above ensures that the configured <code class="literal">MessageSource</code> is polled for messages, which are then available for manipulation with any Spring Integration mechanism on the <code class="literal">pubsubInputChannel</code> message channel.
For example, messages can be retrieved in a method annotated with <code class="literal">@ServiceActivator</code>, as seen below.</p><p>For additional flexibility, <code class="literal">PubSubMessageSource</code> attaches an <code class="literal">AcknowledgeablePubSubMessage</code> object to the <code class="literal">GcpPubSubHeaders.ORIGINAL_MESSAGE</code> message header.
The object can be used for manually (n)acking the message.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "pubsubInputChannel")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> messageReceiver(String payload,
        <em><span class="hl-annotation" style="color: gray">@Header(GcpPubSubHeaders.ORIGINAL_MESSAGE)</span></em> AcknowledgeablePubsubMessage message)
            <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> InterruptedException {
    LOGGER.info(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Message arrived by Synchronous Pull! Payload: "</span> + payload);
    message.ack();
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p><code class="literal">AcknowledgeablePubSubMessage</code> objects acquired by synchronous pull are aware of their own acknowledgement IDs.
Streaming pull does not expose this information due to limitations of the underlying API, and returns <code class="literal">BasicAcknowledgeablePubsubMessage</code> objects that allow acking/nacking individual messages, but not extracting acknowledgement IDs for future processing.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_channel_adapter" href="#_outbound_channel_adapter"></a>7.1.3&nbsp;Outbound channel adapter</h3></div></div></div><p><code class="literal">PubSubMessageHandler</code> is the outbound channel adapter for GCP Pub/Sub that listens for new messages on a Spring <code class="literal">MessageChannel</code>.
It uses <code class="literal">PubSubTemplate</code> to post them to a GCP Pub/Sub topic.</p><p>To construct a Pub/Sub representation of the message, the outbound channel adapter needs to convert the Spring <code class="literal">Message</code> payload to a byte array representation expected by Pub/Sub.
It delegates this conversion to the <code class="literal">PubSubTemplate</code>.
To customize the conversion, you can specify a <code class="literal">PubSubMessageConverter</code> in the <code class="literal">PubSubTemplate</code> that should convert the <code class="literal">Object</code> payload and headers of the Spring <code class="literal">Message</code> to a <code class="literal">PubsubMessage</code>.</p><p>To use the outbound channel adapter, a <code class="literal">PubSubMessageHandler</code> bean must be provided and configured on the user application side.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "pubsubOutputChannel")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler messageSender(PubSubTemplate pubsubTemplate) {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubMessageHandler(pubsubTemplate, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"topicName"</span>);
}</pre><p>The provided <code class="literal">PubSubTemplate</code> contains all the necessary configuration to publish messages to a GCP Pub/Sub topic.</p><p><code class="literal">PubSubMessageHandler</code> publishes messages asynchronously by default.
A publish timeout can be configured for synchronous publishing.
If none is provided, the adapter waits indefinitely for a response.</p><p>It is possible to set user-defined callbacks for the <code class="literal">publish()</code> call in <code class="literal">PubSubMessageHandler</code> through the <code class="literal">setPublishFutureCallback()</code> method.
These are useful to process the message ID, in case of success, or the error if any was thrown.</p><p>To override the default destination you can use the <code class="literal">GcpPubSubHeaders.DESTINATION</code> header.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">private</span> MessageChannel pubsubOutputChannel;

<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; msg) <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">throws</span> MessagingException {
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">final</span> Message&lt;?&gt; message = MessageBuilder
        .withPayload(msg.getPayload())
        .setHeader(GcpPubSubHeaders.TOPIC, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"customTopic"</span>).build();
    pubsubOutputChannel.send(message);
}</pre><p>It is also possible to set an SpEL expression for the topic with the <code class="literal">setTopicExpression()</code> or <code class="literal">setTopicExpressionString()</code> methods.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_header_mapping" href="#_header_mapping"></a>7.1.4&nbsp;Header mapping</h3></div></div></div><p>These channel adapters contain header mappers that allow you to map, or filter out, headers from Spring to Google Cloud Pub/Sub messages, and vice-versa.
By default, the inbound channel adapter maps every header on the Google Cloud Pub/Sub messages to the Spring messages produced by the adapter.
The outbound channel adapter maps every header from Spring messages into Google Cloud Pub/Sub ones, except the ones added by Spring, like headers with key <code class="literal">"id"</code>, <code class="literal">"timestamp"</code> and <code class="literal">"gcp_pubsub_acknowledgement"</code>.
In the process, the outbound mapper also converts the value of the headers into string.</p><p>Each adapter declares a <code class="literal">setHeaderMapper()</code> method to let you further customize which headers you want to map from Spring to Google Cloud Pub/Sub, and vice-versa.</p><p>For example, to filter out headers <code class="literal">"foo"</code>, <code class="literal">"bar"</code> and all headers starting with the prefix "prefix_", you can use <code class="literal">setHeaderMapper()</code> along with the <code class="literal">PubSubHeaderMapper</code> implementation provided by this module.</p><pre class="programlisting">PubSubMessageHandler adapter = ...
...
PubSubHeaderMapper headerMapper = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> PubSubHeaderMapper();
headerMapper.setOutboundHeaderPatterns(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!foo"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!bar"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"!prefix_*"</span>, <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"*"</span>);
adapter.setHeaderMapper(headerMapper);</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The order in which the patterns are declared in <code class="literal">PubSubHeaderMapper.setOutboundHeaderPatterns()</code> and <code class="literal">PubSubHeaderMapper.setInboundHeaderPatterns()</code> matters.
The first patterns have precedence over the following ones.</p></td></tr></table></div><p>In the previous example, the <code class="literal">"*"</code> pattern means every header is mapped.
However, because it comes last in the list, <a class="link" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/util/PatternMatchUtils.html#smartMatch-java.lang.String-java.lang.String%E2%80%A6%E2%80%8B-" target="_top">the previous patterns take precedence</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_3" href="#_sample_3"></a>7.2&nbsp;Sample</h2></div></div></div><p>Available examples:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-sample" target="_top">sender and receiver sample application</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-integration-pubsub-json-sample" target="_top">JSON payloads sample application</a></li><li class="listitem"><a class="link" href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-pubsub-integration/index.html" target="_top">codelab</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channel_adapters_for_google_cloud_storage" href="#_channel_adapters_for_google_cloud_storage"></a>7.3&nbsp;Channel Adapters for Google Cloud Storage</h2></div></div></div><p>The channel adapters for Google Cloud Storage allow you to read and write files to Google Cloud Storage through <code class="literal">MessageChannels</code>.</p><p>Spring Cloud GCP provides two inbound adapters, <code class="literal">GcsInboundFileSynchronizingMessageSource</code> and <code class="literal">GcsStreamingMessageSource</code>, and one outbound adapter, <code class="literal">GcsMessageHandler</code>.</p><p>The Spring Integration Channel Adapters for Google Cloud Storage are included in the <code class="literal">spring-cloud-gcp-storage</code> module.</p><p>To use the Storage portion of Spring Integration for Spring Cloud GCP, you must also provide the <code class="literal">spring-integration-file</code> dependency, since it isn&#8217;t pulled transitively.</p><p>Maven coordinates, using <a class="link" href="multi__getting_started.html#_bill_of_materials" title="2.1.1&nbsp;Bill of Materials">Spring Cloud GCP BOM</a>:</p><pre class="programlisting"><span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.cloud<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-cloud-gcp-storage<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;dependency&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/groupId&gt;</span>
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;artifactId&gt;</span>spring-integration-file<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/artifactId&gt;</span>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-tag">&lt;/dependency&gt;</span></pre><p>Gradle coordinates:</p><pre class="screen">dependencies {
    compile group: 'org.springframework.cloud', name: 'spring-cloud-gcp-starter-storage'
    compile group: 'org.springframework.integration', name: 'spring-integration-file'
}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_channel_adapter" href="#_inbound_channel_adapter"></a>7.3.1&nbsp;Inbound channel adapter</h3></div></div></div><p>The Google Cloud Storage inbound channel adapter polls a Google Cloud Storage bucket for new files and sends each of them in a <code class="literal">Message</code> payload to the <code class="literal">MessageChannel</code> specified in the <code class="literal">@InboundChannelAdapter</code> annotation.
The files are temporarily stored in a folder in the local file system.</p><p>Here is an example of how to configure a Google Cloud Storage inbound channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "new-file-channel", poller = @Poller(fixedDelay = "5000"))</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageSource&lt;File&gt; synchronizerAdapter(Storage gcs) {
  GcsInboundFileSynchronizer synchronizer = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsInboundFileSynchronizer(gcs);
  synchronizer.setRemoteDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>);

  GcsInboundFileSynchronizingMessageSource synchAdapter =
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsInboundFileSynchronizingMessageSource(synchronizer);
  synchAdapter.setLocalDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> File(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"local-directory"</span>));

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> synchAdapter;
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_streaming_channel_adapter" href="#_inbound_streaming_channel_adapter"></a>7.3.2&nbsp;Inbound streaming channel adapter</h3></div></div></div><p>The inbound streaming channel adapter is similar to the normal inbound channel adapter, except it does not require files to be stored in the file system.</p><p>Here is an example of how to configure a Google Cloud Storage inbound streaming channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "streaming-channel", poller = @Poller(fixedDelay = "5000"))</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; streamingAdapter(Storage gcs) {
  GcsStreamingMessageSource adapter =
          <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsStreamingMessageSource(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsRemoteFileTemplate(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsSessionFactory(gcs)));
  adapter.setRemoteDirectory(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>);
  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> adapter;
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_channel_adapter_2" href="#_outbound_channel_adapter_2"></a>7.3.3&nbsp;Outbound channel adapter</h3></div></div></div><p>The outbound channel adapter allows files to be written to Google Cloud Storage.
When it receives a <code class="literal">Message</code> containing a payload of type <code class="literal">File</code>, it writes that file to the Google Cloud Storage bucket specified in the adapter.</p><p>Here is an example of how to configure a Google Cloud Storage outbound channel adapter.</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "writeFiles")</span></em>
<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">public</span> MessageHandler outboundChannelAdapter(Storage gcs) {
  GcsMessageHandler outboundChannelAdapter = <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsMessageHandler(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> GcsSessionFactory(gcs));
  outboundChannelAdapter.setRemoteDirectoryExpression(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"your-gcs-bucket"</span>));

  <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">return</span> outboundChannelAdapter;
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_sample_4" href="#_sample_4"></a>7.4&nbsp;Sample</h2></div></div></div><p>A <a class="link" href="https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-samples/spring-cloud-gcp-integration-storage-sample" target="_top">sample application</a> is available.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi__spring_jdbc.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__spring_cloud_stream.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">6.&nbsp;Spring JDBC&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-gcp.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;8.&nbsp;Spring Cloud Stream</td></tr></table></div></body></html>